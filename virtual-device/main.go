package main

import (
	"log"
	"os"
	"os/signal"
	"syscall"
	"time"

	"github.com/tarm/serial"
)

func main() {
	sigChan := make(chan os.Signal, 1)
	signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

	config := &serial.Config{
		Name:     "/dev/ttyV99",
		Baud:     115200,
		Size:     8,
		Parity:   serial.ParityNone,
		StopBits: serial.Stop1,
	}

	port, err := serial.OpenPort(config)
	if err != nil {
		log.Fatal(err)
	}

	cleanup := func() {
		log.Println("Closing serial port...")
		if err := port.Close(); err != nil {
			log.Printf("Error closing port: %v", err)
		}
		// Give the port a moment to close properly
		time.Sleep(100 * time.Millisecond)
	}
	defer cleanup()

	go handleSendMockData(port)

	// Simulate device data transmission
	for {
		select {
		case <-sigChan:
			log.Println("Shutting down...")
			return
		default:
			_, err := port.Write([]byte("Hello from virtual device\n"))
			if err != nil {
				log.Printf("Error writing to port: %v", err)
			}
			time.Sleep(2 * time.Second)
		}
	}
}

func handleSendMockData(port *serial.Port) {
	mockData := [][]byte{
		{0x02, 0x02, 0xFF, 0x50, 0x25, 0x01, 0x01, 0x01, 0x00, 0x8B},
		{0x02, 0x02, 0xFF, 0x50, 0x25, 0x01, 0x01, 0x00, 0x00, 0x8A},
		{0x02, 0x02, 0xFF, 0x50, 0x25, 0x01, 0x01, 0x08, 0x00, 0x82},
		{0x02, 0x02, 0xFF, 0x50, 0x25, 0x01, 0x01, 0x04, 0x00, 0x8E},
		{0x02, 0x02, 0xFF, 0x50, 0x25, 0x01, 0x01, 0x10, 0x00, 0x9A},
		{0x02, 0x02, 0xFF, 0x50, 0x27, 0x01, 0x01, 0x01, 0x00, 0x89},
		{0x02, 0x02, 0xFF, 0x50, 0x27, 0x01, 0x01, 0x02, 0x00, 0x8A},
		{0x02, 0x02, 0xFF, 0x50, 0x15, 0x01, 0x03, 0x00, 0x00, 0x00, 0xB8},
		{0x02, 0x02, 0xFF, 0x50, 0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0xB9},
		{0x02, 0x02, 0xFF, 0x50, 0x15, 0x01, 0x03, 0x00, 0x02, 0x00, 0xBA},
		{0x02, 0x02, 0xFF, 0x50, 0x15, 0x01, 0x03, 0x00, 0x03, 0x00, 0xBB},
		{0x02, 0x02, 0xFF, 0x50, 0x15, 0x01, 0x03, 0x00, 0x05, 0x00, 0xBD},
	}

	for {
		for _, data := range mockData {
			time.Sleep(1 * time.Second)
			_, err := port.Write(data)
			if err != nil {
				log.Printf("Error writing to port: %v", err)
				continue
			}
		}
	}
}
